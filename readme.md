```php
<?php
//Данная документация собирается автоматически 
//по этому адресу: http://docs.dev.big3.ru/uoit/
?>
```

# Приложение для работы с данными аналитики по объектам обращения с отходами 

Данное приложение предназначено для оперативного наблюдения 
за работой Региональных операторов, перевозчиков и муниципалитетов,
касающейся сбора и вывоза отходов в регионах РФ

# Кластеризация точек в БД

При помощи хранимых процедур PostgreSQL приложение кластеризует точки объектов на карте для уровня зумов от 0 до 15, 
указывая количество вошедших в кластер точек. Кластеризация происходит методом центрирования масс.

# Аналитика в ClickHouse

Приложение использует ClickHouse для хранения информации о маршрутах и визитах. В данную БД приложение обращается только
с аналитическими запросами.

# Подготовка локальных данных

Перед началом работы нужно выполнить:

```
./manage.py migrate
psql -h 127.0.0.1 < sql/waypoints.sql
psql -h 127.0.0.1 < sql/compile_destination_into_cluster.sql
psql -h 127.0.0.1 < sql/process_waypoint.sql
./prepare-clusters.py init-distances
```

Подготовить кластеры для текущего дня:

```
./prepare-clusters.py compile
```

# API 

## Объекты

### Регионы

Регионы - это субъекты РФ (на текущий момент 07.2020 - 75 штук). Регионы охарактеризованы названием, а также полной (детальной) и упрощенной (для лучшей загрузки)
географической геометрией.

Свойства: 

- наименование
- географический объект (полигон)
- упрощенный географический объект для быстрого отображения
- ответственный (пользователь системы)

### Муниципалитеты

Муниципалитеты - это районы, на которые поделен каждый федеральный субъект.

Свойства:

- свойства региона
- привязка к региону

### МНО

Места накопленя отходов - географические объекты (точки, описанные парой координат). В общем случае это площадки с мусорными контейнерами.
У каждого МНО должны быть координаты, адрес, а также зона РО и муниципалитет, к которому она привязана. Кроме того за площадкой может быть закреплен
перевозчик.

### Кластеры МНО

Кластеры МНО генерируются при помощи хранимой процедуры в PostgreSQL. Наборы кластеров объектов сохраняются для уровней зума от 1 до 16 включительно.

Для каждого уровня зума нужно настроить дистанцию для объединения объектов в кластере (дистанция описана в таблице cluster_distance). Дистанция
подбирается исходя из визуального предпочтения (в идеале в одном экране карты на фронтенде не должно быть больше 20-30 кластеров)

При этом кластеры генерируются иерархически, то есть более подробные кластеры объединяются в менее подробные друг за другом, это значит,
что если поменять дистанцию на каких-то уровнях зума (кроме последнего самого крупного), изменятся кластеры и на следующих, поэтому изменяя дистанцию,
нужно это учитывать.

### Агрегированные данные

Агрегированные данные представляют собой количество событий, привязанных к кластеру, региону или муниципалитету за определенный день. При каждом визите
происходит инкремент агрегированных данных в соответствующих таблицах для региона, муниципалитета и 16-ти кластеров, в которые попадает посещенная МНО.

## Данные аналитики

Данные аналитики делятся на состояния и временные ряды. 

Состояния выражены в общем случае числом, а временные ряды - группой чисел с определенным шагом.

### Временные ряды

Временные ряды делятся на ежедневные срезы, ежемесячные срезы и актуальную информацию (срезы по 10 минут на текущий день). Ежедневные и ежемесячные срезы хранятся в 
PostgreSQL в виде агрегированных данных. Это же относится к данным "на сейчас" - срез на последний день всегда содержит актуальную информацию.

Срезы по 10 минут делать не рентабильно по нагрузке на БД, поэтому данные за конкретное время на сегодня запрашиваются из СlickHouse.

При этом срезы за 1 день формируются с учетом часового пояса региона. Приложение выбирает день для агрегации исходя из настроек часового пояса региона,
 в котором размещен объект.
 
Общий URI запроса на временной ряд выглядит следующим образом:

`/api/stat-range/\<type\>/\<range-type\>/?\<filter:optional\>`

Где 

- type - тип данных (cleaned-waste-site, uncleaned-waste-site, overall-waste-site и тд)
- range-type - временной диапазон для агрегации (monthly, daily, recent)
- filter - параметры фильтрации, например, регион или муниципалитет, по которому выдаются данные

Структура ответа:

```json
[
    {
        type: <range-type>,
        datetime: datetime,
        stat: float
    }, ...
]
```

### Состояния

Состояния - это фиксированные показатели по региону, муниципалитету или всей стране, выраженные в числах. 

Состояния могут выдаваться:
- в разрезе регионов страны
- в разрезе муниципалитетов региона
- в разрезе зон РО региона


В общем случае адреса запросов состояний имеют вид

`/api/stat/\<type\>/\<frame:optional\>/?\<filter:optional\>`

Где

- type - тип данных (cleaned-waste-site, uncleaned-waste-site, overall-waste-site и тд)
- frame (не обязательно) - разрез, в котором нужно вывести данные. (region, borough, cluster, и тд)
При отсутствии данного параметра будет выведено состояние по всей стране
- filter (не обязательно) - get-параметры фильтрации, например конкретное время, на которое нужно выдать состояние, в том числе
можно передать конкретный идентификатор единицы среза, когда нужно получить состояние только по одному субъекту РФ, муниципалитету или зоне РО

Структура ответа:

```json
[
    {
        frame: <frame>,
        id: <id>,
        stat: float
    }, ...
]
```

Где frame и id соответственно тип разреза и его идентификатор, а также передается дата-время на которое актуально данное 
состояние и само состояние числом.

### Совокупная информация

Нередко у фронтенд-приложения появляется необходимость получить 
исчерпывающую информацию по какому-либо объекту, в этом случае следует использовать запросы статистики
данного типа.

Вид запроса

```
/api/stat/summary/
/api/stat/summary/\<type\>/\<id\>/?\<filter:optional\>
```

где

- type - тип объекта (region, borough, waste_site, ...). При отсутствии параметра данные выдаются по
всей стране
- id - идентификатор объекта
- filter - дополнительные параметры фильтрации (конкретное время, дата и тд)

Формат ответа - объект. содержащий информацию об объекте

- id
- name
- stat - объект, содержащий всю информацию по статистике данного объекта 

## Маршруты

Маршруты - это полная савокупность информации о перемещении контейнеровоза за 1 календарный день.
Все маршруты хранятся в ClickHouse - в базе приложения хранятся только недавние маршруты для расчета посещений.

Приложение отдает по API маршруты за выбранный день, попадающие в определенные рамки пользовательского
экрана при просмотре карты. Так как информации о маршрутах очень много, приложение упрощает информацию о маршруте 
и сокращает ее объем перед выводом. 


## Посещения

Посещение - это факт очистки МНО контейнеровозом. 

За логику создания посещений отвечает сервис ОЛТП. В базе приложения хранятся
все посещения. Также при создании нового посещения происходит инкремент кол-ва посещений 
в соответствующих кластерах и аггрегированной статистике по регионам и муниципалитетам.

Страница для имитации маршрутов автомобилей

[http://app.dev.oc.big3.ru/tracking-map/map-app](http://app.dev.oc.big3.ru/tracking-map/map-app)


